---
- hosts: localhost

  tasks:
    - name: Upgrade apt packages
      become: yes
      apt:
        upgrade: yes
        update_cache: yes

    - name: Install basics
      become: yes
      apt:
        pkg:
          - software-properties-common
          - build-essential
          - htop
          - git
          - fonts-jetbrains-mono
          - tmux
          - stow
          - gnome-tweaks
        state: latest
        update_cache: yes
      tags: basic

    # Install Chrome
    - name: Remove Firefox
      become: yes
      apt:
        name: firefox
        state: absent
      tags: chrome

    - name: Add Chrome Apt signing key
      become: yes
      apt_key:
        url: "https://dl.google.com/linux/linux_signing_key.pub"
        state: present
      tags: chrome

    - name: Add Chrome repository into sources list
      become: yes
      apt_repository:
        repo: deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main
        state: present
      tags: chrome

    - name: Install google-chrome-stable
      become: yes
      apt:
        name: google-chrome-stable
        state: latest
        update_cache: yes
      tags: chrome

    # Install AppImageLauncher
    - name: Add AppImageLauncher repository into sources list
      become: yes
      apt_repository:
        repo: ppa:appimagelauncher-team/stable
        state: present
      tags: appimagelauncher

    - name: Install AppImageLauncher
      become: yes
      apt:
        name: appimagelauncher
        state: latest
        update_cache: yes
      tags: appimagelauncher

    - name: Create ~/Applications directory
      file:
        path: "{{ ansible_env.HOME }}/Applications"
        state: directory
      tags: appimagelauncher

    # Install WezTerm
    - name: Install WezTerm
      get_url:
        url: https://github.com/wez/wezterm/releases/download/20221119-145034-49b9839f/WezTerm-20221119-145034-49b9839f-Ubuntu18.04.AppImage
        dest: "{{ ansible_env.HOME }}/Applications/WezTerm"
        mode: a+x
      tags: wezterm

    # Install and configure zsh
    - name: Install zsh
      become: yes
      apt:
        pkg: zsh
        state: latest
        update_cache: yes
      tags: zsh

    - name: Change user shell to zsh 
      become: yes
      user:
        name: "{{ ansible_user_id }}"
        shell: /bin/zsh
      tags: zsh

    - name: Check if ohmyzsh installed
      stat:
        path: "{{ ansible_env.HOME }}/.oh-my-zsh/oh-my-zsh.sh"
      tags: zsh
      register: ohmyzsh

    - name: Download ohmyzsh install script
      get_url:
        url: https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh
        dest: "{{ ansible_env.HOME }}/install.sh"
        mode: a+x
      when: not ohmyzsh.stat.exists
      tags: zsh

    - name: Install ohmyzsh
      command:
        cmd: "{{ ansible_env.HOME }}/install.sh"
        creates: "{{ ansible_env.HOME }}/.oh-my-zsh/oh-my-zsh.sh"
      when: not ohmyzsh.stat.exists
      tags: zsh

    - name: Remove ohmyzsh defaults
      file:
        path: "{{ ansible_env.HOME }}/{{ item }}"
        state: absent
      with_items:
        # - .zshrc
        - .zshrc.pre-oh-my-zsh
        - install.sh
      tags: zsh

    # Install and configure tmux
    - name: Install tmux
      become: yes
      apt:
        pkg: tmux
        state: latest
        update_cache: yes
      tags: tmux

    - name: Create ~/.tmux/plugins/tpm directory
      file:
        path: "{{ ansible_env.HOME }}/.tmux/plugins/tpm"
        state: directory
      tags: tmux

    - name: Install Tmux Plugin Manager
      git:
        repo: https://github.com/tmux-plugins/tpm
        dest: "{{ ansible_env.HOME }}/.tmux/plugins/tpm"
      tags: tmux

    # Install Neovim
    - name: Install Neovim
      become: yes
      get_url:
        url: https://github.com/neovim/neovim/releases/latest/download/nvim.appimage
        dest: /usr/bin/nvim
        owner: root
        group: root
        mode: a+x
      tags: nvim

    - name: Create vim-plug directory
      file:
        path: "{{ ansible_env.HOME }}/.local/share/nvim/site/autoload"
        state: directory
      tags: nvim

    - name: Install vim-plug
      get_url:
        url: https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
        dest: "{{ ansible_env.HOME }}/.local/share/nvim/site/autoload/plug.vim"
      tags: nvim

    # Clone and symlink dotfiles
    - name: Clone dotfiles
      git:
        repo: https://github.com/imryche/dotfiles
        dest: "{{ ansible_env.HOME }}/dotfiles"
      tags: dotfiles

    - name: Run stow
      shell:
        chdir: "{{ ansible_env.HOME }}/dotfiles"
        cmd: "stow wezterm zsh tmux nvim sqlite touchegg --target {{ ansible_env.HOME }} --verbose=2"
      register: result
      changed_when: 'result.stderr is search("LINK: ")'
      tags: dotfiles

    # Install Python
    - name: Add deadsnakes repository into sources list
      become: yes
      apt_repository:
        repo: ppa:deadsnakes/ppa
        state: present

    - name: Install system Python packages
      become: yes
      apt:
        pkg:
          - python3-pip
          - python3-dev
          - python3.11
          - python3.11-dev
          - python-is-python3
        state: latest
        update_cache: yes

    - name: Install virtualenvwrapper
      become: yes
      pip:
        name: virtualenvwrapper

    # Install Obsidian
    - name: Install Obsidian
      get_url:
        url: https://github.com/obsidianmd/obsidian-releases/releases/download/v1.0.3/Obsidian-1.0.3.AppImage
        dest: "{{ ansible_env.HOME }}/Applications/Obsidian"
        mode: a+x
      tags: obsidian

    # Install flatpaks
    - name: Install flatpaks
      become: yes
      flatpak:
        name: "{{ item }}" 
        state: present
      with_items:
        - org.telegram.desktop
        - com.spotify.Client
        - com.github.joseexposito.touche
      tags: flatpaks
